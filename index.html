<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>🔐 Crypto Playground</title>
  <style>
    html, body {
      font-family: Arial, Helvetica, sans-serif;
      color: #2e2e2e;
      padding-top: 60px;
    }

    textarea {
      resize: none;
    }

    .page {
      width: 100%;
      text-align: center;
    }

    .page-welcome .safe-emoji {
      font-size: 60px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
    const enc = new TextEncoder();
    const dec = new TextDecoder("utf-8");

    const publicKey = localStorage.getItem('publicKey') || undefined;
    const privateKey = localStorage.getItem('privateKey') || undefined;
    const encryptedData = localStorage.getItem('encryptedData') || undefined;
    const encryptedDataKey = localStorage.getItem('encryptedDataKey') || undefined;
    let sessionKey = undefined;

    window.onload = function() {
      generateSessionKey();

      if (publicKey && privateKey) {
        render(pageSafe);        
      } else if (!publicKey && !privateKey) {
        render(pageWelcome);
      } else {
        render(pageError);
      }
    }

    async function generate() {
      const key = await generateRSAKey();
      const exportedPublicKey = await exportKey(key.publicKey);
      const exportedPrivateKey = await exportKey(key.privateKey);

      localStorage.setItem('publicKey', JSON.stringify(exportedPublicKey));
      localStorage.setItem('privateKey', JSON.stringify(exportedPrivateKey));

      location.reload();
    }

    async function lock(event) {
      const safe = document.querySelector('#safe');
      const data = enc.encode(safe.value);
      const encryptedData = await encrypt(sessionKey, data);
      const exportedSessionKey = await exportKey(sessionKey);

      localStorage.setItem('encryptedData', encryptedData);
      localStorage.setItem('encryptedDataKey', JSON.stringify(exportedSessionKey));

      location.reload();
    }

    async function unlock() {
      const key = await importKey(JSON.parse(encryptedDataKey), 'AES-CTR');
      const decrypted = await decrypt(key, encryptedData);
      
      alert(decrypted);

      location.reload();
    }

    async function generateRSAKey() {
      const alg = {name: 'RSA-OAEP', modulusLength: 2048, publicExponent: new Uint8Array([0x01, 0x00, 0x01]), hash: {name: 'SHA-256'}};
      return await window.crypto.subtle.generateKey(alg, true, ['encrypt', 'decrypt']);
    }

    async function generateSessionKey() {
      const alg =  {name: 'AES-CTR', length: 256};
      sessionKey = await window.crypto.subtle.generateKey(alg, true, ['encrypt', 'decrypt']);
    }

    async function encrypt(key, data) {
      const alg = {name: 'AES-CTR', counter: new Uint8Array(16), length: 128};
      const ciphertext = await window.crypto.subtle.encrypt(alg, key, data)

      // https://gist.github.com/chrisveness/43bcda93af9f646d083fad678071b90a
      // ciphertext as byte array
      const ciphertextArray = Array.from(new Uint8Array(ciphertext));
      // ciphertext as string
      const ciphertextStr = ciphertextArray.map(byte => String.fromCharCode(byte)).join('');
      // encode ciphertext as base64
      const ciphertextBase64 = btoa(ciphertextStr);

      return ciphertextBase64;
    }

    async function decrypt(key, data) {
      // decode base64 ciphertext
      const ciphertextStr = atob(data);
      // ciphertext as Uint8Array
      let ciphertextArr = [];
      for (var i = 0; i < ciphertextStr.length; i++) {
        ciphertextArr.push(ciphertextStr.charAt(i).charCodeAt(0));
      }

      const ciphertextStrUint8 = new Uint8Array(ciphertextArr);

      const alg = {name: 'AES-CTR', counter: new ArrayBuffer(16), length: 128};

      const buffer = await window.crypto.subtle.decrypt(alg, key, ciphertextStrUint8);

      // decode text from UTF-8
      const plaintext = dec.decode(buffer);

      return plaintext;
    }

    async function exportKey(key) {
      return await window.crypto.subtle.exportKey('jwk', key);
    }

    async function importKey(jwk, algorithm) {
      console.log(algorithm);
      return await window.crypto.subtle.importKey('jwk', jwk, {name: algorithm}, true, ['encrypt', 'decrypt']);
    }

    function render(page) {
      document.querySelector('#root').innerHTML = page();
    }

    const pageWelcome = () => {
      return (
        `<div class="page page-welcome">
          <h1>Welcome!</h1>
          <h2>This is your safe.</h2>
          <span class="safe-emoji">🗄</span>
          <p>The safe is not setup yet. For first of all let's <button onclick="generate()">generate</button> a public and secret keys 🔑.</p>
        </div>`
      );
    }

    const pageSafe = () => {
      return (
        `<div class="page page-safe">
          <h1>${encryptedData && encryptedDataKey ? 'The safe is closed 🔒.' : 'The safe is open 🔓.'}</h1>
          <textarea name="safe" id="safe" cols="30" rows="10" ${encryptedData && encryptedDataKey ? 'disabled' : ''}></textarea>
          <br>
          ${encryptedData && encryptedDataKey ?
            '<button onclick="unlock()">Unlock</button>' :
            '<button onclick="lock()">Lock</button>'
          }
        </div>`
      );
    }

    const pageError = () => {
      return (
        `<div class="page page-error">
          <h1>Oooops something went wrong 🤷‍.</h1>
        </div>`
      );
    }
  </script>
</body>
</html>